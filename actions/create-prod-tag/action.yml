name: "Create Production Tag"

inputs:
  gihub_app_id:
    description: "GitHub App Id"
    required: true
  gihub_private_key:
    description: "GitHub App Name"
    required: true
  jenkins_url:
    description: "Jenkins URL"
    required: true
  jenkins_job_folder:
    description: "Jenkins Job Folder"
    required: true
    default: ${{ github.repository_owner }}
  jenkins_job_name:
    description: "Jenkins Job Name"
    required: true
    default: ${{ github.repository }}
  jenkins_user:
    description: "Jenkins User"
    required: true
  jenkins_token:
    description: "Jenkins token"
    required: true

runs:
  using: "composite"
  steps:
    - name: Create GitHub App Token
      uses: actions/create-github-app-token@v1
      id: github-app-token
      with:
        app-id: ${{ inputs.gihub_app_id }}
        private-key: ${{ inputs.gihub_private_key }}

    - name: Checkout source
      uses: actions/checkout@v4
      with:
        token: ${{ steps.github-app-token.outputs.token }}
        ref: ${{ github.head_ref }}

    - name: Tag new release
      id: tag-release
      run: |
        git config --global --add safe.directory /harness
        git config --global user.email "github-actions@github.com"
        git config --global user.name "github-actions"
        
        chmod +x ./tools/create_release.sh
        ./tools/create_release.sh
      env:
        GITHUB_TOKEN: ${{ steps.github-app-token.outputs.token }}
      shell: "bash"

    - name: Trigger Jenkins build PROD
      run: |
        chmod +x ./tools/jenkins_build_tag.sh
        ./tools/jenkins_build_tag.sh \
          ${{ inputs.jenkins_url }} \
          ${{ inputs.jenkins_job_folder }} \
          ${{ inputs.jenkins_job_name }} \
          ${{ inputs.jenkins_user }} \
          ${{ inputs.jenkins_token }} \
          ${{ steps.tag-release.outputs.release_version }}
      shell: "bash"
